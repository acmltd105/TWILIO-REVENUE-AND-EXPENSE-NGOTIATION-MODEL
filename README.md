# Twilio Revenue & Expense Negotiation Model

The repository now ships an end-to-end, liquid-glass executive dashboard that unifies
120 SKU pricing rows, the Python negotiation engine, Supabase persistence (with
local failover), and a hardened trailing-90 spend pipeline.

## What’s Included

| Layer | Highlights |
| --- | --- |
| **Frontend** | Vite + React + Tailwind client in `apps/pro-dashboard` with a Fortune-10 blue/green theme, animated DPCyeah & Twilio marks, full SKU table, projection tooling, and CSV/JSON exports. |
| **Backend** | FastAPI service in `backend/api.py` wraps `calculate_negotiation_envelope`, normalises scenario inputs, persists to Supabase when configured, and falls back to on-disk storage. |
| **Data** | Canonical catalog generated by `scripts/build_catalog.py` guarantees 120 SKUs with rack, contract, discount, and price-after-discount fields. Automated tests enforce schema correctness. |
| **Finance Pipeline** | `invoice_rollup.py` now emits logging, validates CSV inputs, and mirrors the trailing-90 spend artifact into the dashboard’s public assets. |

## Getting Started

1. **Install Python dependencies**
   ```bash
   pip install -e .[dev]
   ```

2. **Install Node tooling for the dashboard**
   ```bash
   npm install
   ```

3. **Generate or refresh the SKU catalog**
   ```bash
   python scripts/build_catalog.py
   ```

4. **Roll up invoices (optional)**
   ```bash
   python invoice_rollup.py
   ```

5. **Run the React dev server**
   ```bash
   npm run dev
   ```
   The compiled site is emitted to `docs/pro-dashboard` during `npm run build` for GitHub Pages.

6. **Start the negotiation API**
   ```bash
   uvicorn backend.api:app --reload
   ```
   Configure Supabase credentials with `SUPABASE_URL` and `SUPABASE_SERVICE_ROLE_KEY` to enable managed persistence. Without credentials, the API stores the latest scenario in `data/scenario_cache.json`.

## Quality Gates

- `npm run build` — type-checks and bundles the React client.
- `pytest` — validates catalog schema, negotiation model behaviour, and API endpoints.
- `python invoice_rollup.py` — validates finance inputs and publishes the trailing-90 spend artifact.

Each command surfaces explicit errors (at least ten checks across the stack) before deployment, aligning with the “error-proof, self-healing” directive.

## Key Paths

- `apps/pro-dashboard/src` — React components, hooks, and utility math mirroring the negotiation assumptions.
- `backend/api.py` — FastAPI application and Supabase integration logic.
- `data/twilio_sku_catalog.json` — Source of truth for SKU pricing; copied to the dashboard during builds.
- `docs/pro-dashboard/` — Static build artefacts served via GitHub Pages.

## Tests

Execute the entire suite after making changes:

```bash
pytest
npm run build
python invoice_rollup.py
```

All tests must pass and the working tree must be clean before merging.
